# AI / ML Design â€” CowetaConnect Lead Intelligence Engine

> **Document Type:** AI/ML Architecture  
> **Version:** 1.0.0  
> **Framework:** ML.NET (C#)

---

## 1. Problem Statement

Small business owners in rural and semi-rural Oklahoma often lack the market research resources that larger businesses have. CowetaConnect's AI Lead Engine solves this by passively observing what local consumers are searching for and where they're searching from â€” then surfacing meaningful demand signals to business owners.

**Goal:** Identify geographic market opportunities â€” cities or ZIP codes with measurable search demand for a business category or specific business, where that business currently has no presence or low click engagement.

---

## 2. The Lead Generation Model

### 2.1 What is a "Lead"?

A lead in this context is a **geographic demand signal**:

> "Users in [City X] have searched for [Product/Service Y] [N] times in the last 30 days, but businesses like yours are not getting clicks from that area."

This is NOT a sales lead in the traditional CRM sense. It's a market signal â€” an opportunity zone the business owner can act on.

### 2.2 Feature Engineering

The ML model operates on the `demand_aggregates` table. Features fed into the model:

| Feature | Type | Description |
|---|---|---|
| `search_count_30d` | Float | Number of searches in last 30 days from demand_city |
| `click_count_30d` | Float | Number of clicks to this business from demand_city |
| `click_through_rate` | Float | click_count / search_count |
| `trend_pct` | Float | % change in search_count vs prior 30 days |
| `demand_city_distance_km` | Float | Distance from business to demand_city centroid |
| `category_avg_search_volume` | Float | Avg search volume for this category platform-wide |
| `competing_businesses_in_demand_city` | Int | # of other businesses in same category in demand_city |
| `business_age_days` | Int | Days since business joined platform |
| `existing_engagement` | Float | Historical CTR from demand_city (if any) |

### 2.3 Label Definition

This is a **binary classification** problem (for the initial model):

- **Label = 1 (Opportunity):** demand_city shows high search volume, low or zero engagement â†’ business should consider expanding reach here
- **Label = 0 (No Signal):** baseline or already-captured demand

Ground truth labels for training are initially generated by **rule-based heuristics** (bootstrapping), then refined using owner feedback (was the lead useful? did they act on it?).

**Bootstrapping Rule:**
```
Label = 1 IF:
  search_count_30d >= 10
  AND click_through_rate < 0.05
  AND trend_pct >= 0
  AND competing_businesses_in_demand_city < 3
```

---

## 3. ML.NET Implementation

### 3.1 Model Type

**FastTree Binary Classifier** (Gradient Boosted Decision Trees)

Why: Works well with tabular data, handles missing values, interpretable feature importance, trains fast on modest data volumes.

Fallback: **Linear SVM** for very early stage when data is thin.

### 3.2 Training Pipeline (C#)

```csharp
// LeadScoringTrainer.cs
public class LeadScoringTrainer
{
    private readonly MLContext _mlContext;
    private readonly ILeadTrainingDataRepository _repo;
    
    public LeadScoringTrainer(ILeadTrainingDataRepository repo)
    {
        _mlContext = new MLContext(seed: 42);
        _repo = repo;
    }

    public async Task<ITransformer> TrainAsync()
    {
        var trainingData = await _repo.GetTrainingDataAsync();
        var dataView = _mlContext.Data.LoadFromEnumerable(trainingData);

        var pipeline = _mlContext.Transforms.Concatenate("Features",
                nameof(LeadFeatureRow.SearchCount30d),
                nameof(LeadFeatureRow.ClickCount30d),
                nameof(LeadFeatureRow.ClickThroughRate),
                nameof(LeadFeatureRow.TrendPct),
                nameof(LeadFeatureRow.DemandCityDistanceKm),
                nameof(LeadFeatureRow.CategoryAvgSearchVolume),
                nameof(LeadFeatureRow.CompetingBusinessesInDemandCity),
                nameof(LeadFeatureRow.BusinessAgeDays),
                nameof(LeadFeatureRow.ExistingEngagement))
            .Append(_mlContext.Transforms.NormalizeMinMax("Features"))
            .Append(_mlContext.BinaryClassification.Trainers.FastTree(
                labelColumnName: nameof(LeadFeatureRow.Label),
                featureColumnName: "Features",
                numberOfLeaves: 20,
                numberOfTrees: 100,
                minimumExampleCountPerLeaf: 5,
                learningRate: 0.1));

        var trainTestSplit = _mlContext.Data.TrainTestSplit(dataView, testFraction: 0.2);
        var model = pipeline.Fit(trainTestSplit.TrainSet);

        EvaluateModel(model, trainTestSplit.TestSet);

        return model;
    }

    private void EvaluateModel(ITransformer model, IDataView testData)
    {
        var predictions = model.Transform(testData);
        var metrics = _mlContext.BinaryClassification.Evaluate(predictions,
            labelColumnName: nameof(LeadFeatureRow.Label));

        Log.Information("ML Model Evaluation: AUC={Auc:F3}, F1={F1:F3}, Accuracy={Acc:F3}",
            metrics.AreaUnderRocCurve,
            metrics.F1Score,
            metrics.Accuracy);
    }
}
```

### 3.3 Feature Row and Prediction Classes

```csharp
public class LeadFeatureRow
{
    public bool Label { get; set; }           // Training only
    public float SearchCount30d { get; set; }
    public float ClickCount30d { get; set; }
    public float ClickThroughRate { get; set; }
    public float TrendPct { get; set; }
    public float DemandCityDistanceKm { get; set; }
    public float CategoryAvgSearchVolume { get; set; }
    public float CompetingBusinessesInDemandCity { get; set; }
    public float BusinessAgeDays { get; set; }
    public float ExistingEngagement { get; set; }
}

public class LeadPrediction
{
    [ColumnName("PredictedLabel")]
    public bool IsOpportunity { get; set; }

    [ColumnName("Probability")]
    public float OpportunityScore { get; set; }

    [ColumnName("Score")]
    public float RawScore { get; set; }
}
```

### 3.4 Inference Service

```csharp
public class LeadScoringService : ILeadScoringService
{
    private PredictionEngine<LeadFeatureRow, LeadPrediction> _predictionEngine;
    private readonly IModelStore _modelStore;

    public LeadScoringService(IModelStore modelStore)
    {
        _modelStore = modelStore;
        ReloadModel();
    }

    public LeadPrediction Score(DemandAggregate aggregate, BusinessContext business)
    {
        var features = MapToFeatures(aggregate, business);
        return _predictionEngine.Predict(features);
    }

    public void ReloadModel()
    {
        var mlContext = new MLContext();
        var model = mlContext.Model.Load(_modelStore.GetLatestModelPath(), out _);
        _predictionEngine = mlContext.Model.CreatePredictionEngine<LeadFeatureRow, LeadPrediction>(model);
    }

    private LeadFeatureRow MapToFeatures(DemandAggregate agg, BusinessContext biz) =>
        new LeadFeatureRow
        {
            SearchCount30d = agg.SearchCount,
            ClickCount30d = agg.ClickCount,
            ClickThroughRate = agg.ClickThroughRate,
            TrendPct = (float)agg.TrendPct,
            DemandCityDistanceKm = GeoCalculator.DistanceKm(biz.Lat, biz.Lng, agg.DemandCityLat, agg.DemandCityLng),
            CategoryAvgSearchVolume = biz.CategoryAvgSearchVolume,
            CompetingBusinessesInDemandCity = agg.CompetingBusinessCount,
            BusinessAgeDays = (float)(DateTime.UtcNow - biz.CreatedAt).TotalDays,
            ExistingEngagement = agg.HistoricalCtr
        };
}
```

### 3.5 Model Lifecycle

```
[Nightly Aggregation Job]
  â†’ Reads raw search_events
  â†’ Computes demand_aggregates
  
[Weekly Retraining Job â€” Sundays 2 AM CT]
  â†’ LeadScoringTrainer.TrainAsync()
  â†’ Evaluates model (AUC threshold: > 0.72)
  â†’ If passes: saves to /models/lead-scoring-{yyyyMMdd}.zip
  â†’ Updates model pointer in Redis ("current_model_path")
  â†’ LeadScoringService.ReloadModel() called via IModelStore event

[Weekly Scoring Job â€” Mondays 3 AM CT]  
  â†’ For each active business Ã— each demand city with recent activity
  â†’ LeadScoringService.Score()
  â†’ Upsert lead_alerts where OpportunityScore > 0.65
```

---

## 4. Geographic Intelligence Layer

### 4.1 IP Geolocation

When a user performs a search, the Analytics Middleware captures their approximate city:

```csharp
// SearchAnalyticsMiddleware.cs
private async Task<GeoLocation> ResolveUserLocation(HttpContext context)
{
    var ip = context.Connection.RemoteIpAddress?.ToString();
    // Use MaxMind GeoLite2 database (free, embedded)
    var city = _geoIpReader.City(IPAddress.Parse(ip));
    return new GeoLocation
    {
        City = city.City.Name ?? "Unknown",
        ZipCode = city.Postal.Code ?? "",
        Lat = city.Location.Latitude ?? 0,
        Lng = city.Location.Longitude ?? 0
    };
}
```

**Privacy:** Raw IPs are never stored. Only resolved City + ZIP codes are written to `search_events`.

### 4.2 Regional Focus

The system defines a **primary service area** of counties:

```csharp
public static class ServiceArea
{
    public static readonly string[] PrimaryCounties = 
        { "Wagoner", "Cherokee", "Muskogee", "Tulsa", "Creek" };
    
    public static readonly string[] PrimaryCities = 
        { "Coweta", "Wagoner", "Broken Arrow", "Muskogee", "Tahlequah", 
          "Sapulpa", "Checotah", "Catoosa" };

    // Only surface leads for demand cities within 75 miles of business
    public const double MaxLeadRadiusMiles = 75.0;
}
```

---

## 5. Model Monitoring & Quality Gates

| Metric | Minimum Threshold | Action if Below |
|---|---|---|
| AUC-ROC | 0.72 | Do not deploy; use previous model |
| F1 Score | 0.65 | Alert architect, investigate data quality |
| Precision | 0.60 | Acceptable (better false negatives than false positives for UX) |
| Training data rows | 500 | Use rule-based fallback, skip ML model |

---

## 6. Owner-Facing Lead UX

### Lead Card (Dashboard)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ Market Opportunity Alert                    [NEW]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 47 people in Broken Arrow searched for local honey      â”‚
â”‚ and bee products in the last 30 days.                   â”‚
â”‚                                                         â”‚
â”‚ Opportunity Score: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  82%                      â”‚
â”‚ Trend: â†‘ +34% vs last month                            â”‚
â”‚                                                         â”‚
â”‚ Competing businesses in that area: 1                    â”‚
â”‚                                                         â”‚
â”‚ [Learn More]  [Dismiss]                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### What "Learn More" Shows

- Search keyword trends (top keywords from that city for their category)
- Map showing demand origin density
- Suggested actions: "Consider attending a Broken Arrow farmers market" / "Create an event in Broken Arrow"
- Link to search for upcoming events in that city on the platform

---

## 7. Future ML Enhancements (Phase 4+)

| Enhancement | Description | Complexity |
|---|---|---|
| Category demand forecasting | Predict upcoming seasonal spikes by category | Medium |
| Business recommendation to users | "Users near you also visited..." | High |
| Event success predictor | Score likelihood of event attendance based on past events | Medium |
| Sentiment from business reviews | NLP on reviews to surface quality signals | High |
